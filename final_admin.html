<!DOCTYPE html>
<html lang="en" class="">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Admin Project Dashboard</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        .transform {
            transition: transform 0.3s ease;
        }
        /* Simple transition for modal */
        .modal-enter {
            opacity: 0;
            transform: scale(0.95);
        }
        .modal-enter-active {
            opacity: 1;
            transform: scale(1);
            transition: all 0.2s ease-out;
        }
        .modal-leave-active {
            opacity: 0;
            transform: scale(0.95);
            transition: all 0.2s ease-in;
        }
    </style>
    <script>
        tailwind.config = {
            darkMode: 'class',
        }
    </script>
</head>
<body class="bg-gray-100 dark:bg-gray-950">

    <div id="app-root" class="flex h-screen font-sans transition-colors duration-300">
        <!-- App content is rendered here by JavaScript -->
    </div>
    <div id="modal-container"></div>

    <script>
        // --- MOCK DATA & CONFIGURATION ---
        const TEAM_MEMBERS = [
            { id: 'u1', name: 'Varsha Kumar', role: 'Lead Designer', avatar: 'https://i.pravatar.cc/150?u=varsha' },
            { id: 'u2', name: 'Praharshini Kumar', role: 'Project Manager', avatar: 'https://i.pravatar.cc/150?u=praharshini' },
            { id: 'u3', name: 'Siddhant Salve', role: 'Lead Developer', avatar: 'https://i.pravatar.cc/150?u=siddhant' },
            { id: 'u4', name: 'Dipraj More', role: 'QA Engineer', avatar: 'https://i.pravatar.cc/150?u=dipraj' },
            { id: 'u5', name: 'Shweta Kumari', role: 'Content Strategist', avatar: 'https://i.pravatar.cc/150?u=shweta' },
            { id: 'u6', name: 'Aryan Sharma', role: 'Jr. Developer', avatar: 'https://i.pravatar.cc/150?u=aryan' },
        ];
        const TODAY = new Date('2025-10-06T00:00:00');
        const initialProjects = [
            {id:'p1',name:'Project Phoenix',platform:'flame',scenario:'3D From Scratch',projectManagerIds:['u2'],updates:[{id:'up1',authorId:'u2',timestamp:'2025-10-01T10:00:00Z',message:'Initial kickoff complete. All systems go.',urgency:'green'},{id:'up2',authorId:'u3',timestamp:'2025-10-04T14:30:00Z',message:'Development environment for render farm is set up.',urgency:'green'},],stages:[{id:'s1-1',name:'Pre-Production',assignedTeamMemberIds:['u1','u5'],tasks:[{id:'t1-1-1',name:'Research & Moodboarding',startDate:'2025-09-15',endDate:'2025-09-25',assignedTeamMemberIds:['u5']},{id:'t1-1-2',name:'Concept Art',startDate:'2025-09-26',endDate:'2025-10-05',assignedTeamMemberIds:['u1']},{id:'t1-1-3',name:'Finalize Scripts',startDate:'2025-10-06',endDate:'2025-10-15',assignedTeamMemberIds:[]},]},{id:'s1-2',name:'Production',assignedTeamMemberIds:['u3'],tasks:[{id:'t1-2-1',name:'3D Modeling',startDate:'2025-10-16',endDate:'2025-10-30',assignedTeamMemberIds:['u3']},{id:'t1-2-2',name:'Texturing & Shading',startDate:'2025-11-01',endDate:'2025-11-10',assignedTeamMemberIds:[]},]},{id:'s1-3',name:'Post-Production',assignedTeamMemberIds:['u4'],tasks:[{id:'t1-3-1',name:'Rendering',startDate:'2025-11-11',endDate:'2025-11-20',assignedTeamMemberIds:[]},{id:'t1-3-2',name:'Compositing & VFX',startDate:'2025-11-21',endDate:'2025-11-30',assignedTeamMemberIds:['u4']},{id:'t1-3-3',name:'Final Review',startDate:'2025-12-01',endDate:'2025-12-05',assignedTeamMemberIds:[]},]},]},
            {id:'p2',name:'Crimson Cascade',platform:'flame',scenario:'Animated Short',projectManagerIds:['u2'],updates:[],stages:[{id:'s2-1',name:'Pre-Production',assignedTeamMemberIds:['u5'],tasks:[{id:'t2-1-1',name:'Storyboarding',startDate:'2025-09-01',endDate:'2025-09-10',assignedTeamMemberIds:[]},{id:'t2-1-2',name:'Animatic',startDate:'2025-09-11',endDate:'2025-09-20',assignedTeamMemberIds:[]},]},{id:'s2-2',name:'Production',assignedTeamMemberIds:['u1'],tasks:[{id:'t2-2-1',name:'Character Animation',startDate:'2025-09-21',endDate:'2025-10-04',assignedTeamMemberIds:['u1']},]},{id:'s2-3',name:'Post-Production',assignedTeamMemberIds:[],tasks:[{id:'t2-3-1',name:'Sound Design',startDate:'2025-10-15',endDate:'2025-10-25',assignedTeamMemberIds:[]},]},]},
            {id:'p3',name:'Quantum Computing Fundamentals',platform:'swayam',scenario:'Expert Led Course',projectManagerIds:['u2'],updates:[{id:'up3',authorId:'u4',timestamp:'2025-10-02T18:00:00Z',message:'Initial module review passed QA.',urgency:'green'},],stages:[{id:'s3-1',name:'Production',assignedTeamMemberIds:['u3','u5'],tasks:[{id:'t3-1-1',name:'Module 1: Filming',startDate:'2025-09-20',endDate:'2025-09-30',assignedTeamMemberIds:['u5']},{id:'t3-1-2',name:'Module 2: Filming',startDate:'2025-10-01',endDate:'2025-10-10',assignedTeamMemberIds:['u3']},]},{id:'s3-2',name:'Post-Production',assignedTeamMemberIds:['u4'],tasks:[{id:'t3-2-1',name:'Module 1: Editing & Graphics',startDate:'2025-10-01',endDate:'2025-10-15',assignedTeamMemberIds:[]},{id:'t3-2-2',name:'Module 2: Editing & Graphics',startDate:'2025-10-16',endDate:'2025-10-30',assignedTeamMemberIds:[]},{id:'t3-2-3',name:'Final QA Pass',startDate:'2025-11-01',endDate:'2025-11-05',assignedTeamMemberIds:['u4']},]},]},
            {id:'p4',name:'Advanced AI Architectures',platform:'swayam',scenario:'University Collaboration',projectManagerIds:['u2'],updates:[],stages:[{id:'s4-1',name:'Production',assignedTeamMemberIds:['u3'],tasks:[{id:'t4-1-1',name:'Curriculum Finalization',startDate:'2025-08-01',endDate:'2025-08-15',assignedTeamMemberIds:[]},{id:'t4-1-2',name:'Guest Speaker Filming',startDate:'2025-08-16',endDate:'2025-08-30',assignedTeamMemberIds:[]},]},{id:'s4-2',name:'Post-Production',assignedTeamMemberIds:[],tasks:[{id:'t4-2-1',name:'Transcription & Subtitles',startDate:'2025-09-01',endDate:'2025-09-15',assignedTeamMemberIds:[]},{id:'t4-2-2',name:'Platform Integration',startDate:'2025-09-16',endDate:'2025-09-25',assignedTeamMemberIds:[]},]},]},
            {id:'p5',name:'Mobile App UX/UI Design',platform:'swayam',scenario:'Beginner Workshop',projectManagerIds:['u2'],updates:[],stages:[{id:'s5-1',name:'Production',assignedTeamMemberIds:['u1'],tasks:[{id:'t5-1-1',name:'Design Asset Creation',startDate:'2025-11-01',endDate:'2025-11-20',assignedTeamMemberIds:['u1']},{id:'t5-1-2',name:'Interactive Prototype Build',startDate:'2025-11-21',endDate:'2025-12-10',assignedTeamMemberIds:[]},]},{id:'s5-2',name:'Post-Production',assignedTeamMemberIds:[],tasks:[{id:'t5-2-1',name:'User Testing Sessions',startDate:'2025-12-11',endDate:'2025-12-20',assignedTeamMemberIds:['u6']},]},]}
        ];

        // --- GLOBAL APP STATE ---
        let state = {
            isDarkMode: false,
            isSidebarCollapsed: false,
            currentPage: 'home',
            projects: JSON.parse(JSON.stringify(initialProjects)),
            pendingProjectId: null,
            selectedProjectIdByPlatform: { flame: null, swayam: null },
            confirmationModal: { isOpen: false },
            taskModal: { isOpen: false },
            openSections: {}
        };

        // --- ICONS (as SVG strings) ---
        const ICONS = {
            home: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5"><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline></svg>`,
            users: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg>`,
            user: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>`,
            settings: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06-.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>`,
            bell: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5"><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path><path d="M13.73 21a2 2 0 0 1-3.46 0"></path></svg>`,
            message: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></svg>`,
            plus: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-4 h-4"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>`,
            search: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5 text-gray-400"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>`,
            logout: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path><polyline points="16 17 21 12 16 7"></polyline><line x1="21" y1="12" x2="9" y2="12"></line></svg>`,
            sun: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5"><circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line></svg>`,
            moon: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg>`,
            trash: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>`,
            calendar: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" class="w-4 h-4"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>`,
            chevronLeft: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6 text-gray-600 dark:text-gray-300"><polyline points="15 18 9 12 15 6"></polyline></svg>`,
            chevronRight: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6 text-gray-600 dark:text-gray-300"><polyline points="9 18 15 12 9 6"></polyline></svg>`,
            chevronDown: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5 text-gray-500"><polyline points="6 9 12 15 18 9"></polyline></svg>`
        };

        // --- HEALTH LOGIC ---
        const getTaskProgress = (task) => {
            const start = new Date(task.startDate + 'T00:00:00Z');
            const end = new Date(task.endDate + 'T23:59:59Z');
            if (TODAY >= end) return 100;
            if (TODAY <= start) return 0;
            const totalDuration = end.getTime() - start.getTime();
            if (totalDuration <= 0) return 0;
            const elapsedDuration = TODAY.getTime() - start.getTime();
            return Math.max(0, Math.min(100, (elapsedDuration / totalDuration) * 100));
        };

        const getTaskStatus = (task) => {
            const endDate = new Date(task.endDate + 'T23:59:59');
            const progress = getTaskProgress(task);
            if (progress >= 100) return { label: 'Completed', color: 'green' };

            const sevenDaysFromNow = new Date(TODAY);
            sevenDaysFromNow.setDate(TODAY.getDate() + 7);
            if (endDate <= sevenDaysFromNow) return { label: 'At-Risk', color: 'yellow' };

            return { label: 'On Track', color: 'green' };
        };

        const calculateStageHealth = (stage) => {
            if (!stage.tasks || stage.tasks.length === 0) return { progress: 0, status: { label: 'On Track', color: 'green' }};
            
            const progress = stage.tasks.reduce((acc, task) => acc + getTaskProgress(task), 0) / stage.tasks.length;
            
            let isOverdue = false;
            let isAtRisk = false;
            
            if (stage.tasks.length > 0) {
                 const lastTask = stage.tasks.reduce((latest, current) => new Date(latest.endDate) > new Date(current.endDate) ? latest : current);
                if (new Date(lastTask.endDate + 'T23:59:59') < TODAY && progress < 100) {
                    isOverdue = true;
                } else {
                    isAtRisk = stage.tasks.some(task => {
                        return getTaskStatus(task).label === 'At-Risk';
                    });
                }
            }
            
            let status = { label: 'On Track', color: 'green' };
            if (isOverdue) status = { label: 'Overdue', color: 'red' };
            else if (isAtRisk) status = { label: 'At-Risk', color: 'yellow' };
            else if (progress >= 100) status = { label: 'Completed', color: 'green' };
            
            return { progress, status };
        };


        const calculateAllProjectsHealth = (projects) => {
            const stageOrder = ['Pre-Production', 'Production', 'Post-Production'];
            return projects.map(p => {
                if (p.stages.length === 0) {
                    return { ...p, overallProgress: 0, overallStatus: { label: 'Setup', color: 'blue' } };
                }
                let hasLaggingStage = false;
                const stagesWithHealth = [...p.stages].sort((a, b) => stageOrder.indexOf(a.name) - stageOrder.indexOf(b.name)).map(stage => {
                    let { progress, status } = calculateStageHealth(stage);
                    if (hasLaggingStage && progress < 100) {
                        status = { label: 'Lagging', color: 'red' };
                    } else if (status.label === 'Overdue') {
                        hasLaggingStage = true;
                    }
                    return { ...stage, progress, status };
                });

                const projectProgress = stagesWithHealth.length > 0 ? stagesWithHealth.reduce((acc, s) => acc + s.progress, 0) / stagesWithHealth.length : 0;
                const projectCompleted = stagesWithHealth.every(s => s.progress >= 100);

                let overallStatus = { label: 'In Progress', color: 'blue' };
                if (projectCompleted) overallStatus = { label: 'Completed', color: 'green' };
                else if (hasLaggingStage || stagesWithHealth.some(s => s.status.label === 'Overdue')) overallStatus = { label: 'Lagging', color: 'red' };
                else if (stagesWithHealth.some(s => s.status.label === 'At-Risk')) overallStatus = { label: 'At-Risk', color: 'yellow' };
                
                return { ...p, stages: stagesWithHealth, overallProgress: projectProgress, overallStatus };
            });
        };
        
        // --- RENDER HELPERS ---
        const renderStatusBadge = (status) => `<span class="px-2.5 py-0.5 text-xs font-medium rounded-full ${ { green: 'bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-300', yellow: 'bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-300', red: 'bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-300', blue: 'bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-300' }[status.color]}">${status.label}</span>`;
        const renderProgressBar = (progress, color) => `<div class="w-full bg-gray-200 rounded-full h-2 dark:bg-gray-700"><div class="${{ green: 'bg-green-500', yellow: 'bg-yellow-500', red: 'bg-red-500', blue: 'bg-blue-500' }[color]} h-2 rounded-full transition-all duration-500" style="width: ${progress}%"></div></div>`;
        const renderAvatar = (userId, size = 'md') => {
            const user = TEAM_MEMBERS.find(u => u.id === userId);
            if (!user) return '';
            const sizeClasses = { sm: 'w-6 h-6', md: 'w-8 h-8', lg: 'w-10 h-10' };
            return `<img class="${sizeClasses[size]} rounded-full object-cover ring-2 ring-white dark:ring-gray-800" src="${user.avatar}" alt="${user.name}" title="${user.name}">`;
        };

        // --- RENDER FUNCTIONS FOR UI COMPONENTS ---
        const renderSidebar = () => {
            const { isDarkMode, isSidebarCollapsed, currentPage } = state;
            const navItems = [ { name: 'Dashboard', icon: 'home', page: 'home' }, { name: 'Users', icon: 'users', page: 'users' }, { name: 'Profile', icon: 'user', page: 'profile' }, { name: 'Settings', icon: 'settings', page: 'settings' }, { name: 'Notifications', icon: 'bell', page: 'notifications' }, { name: 'Messages', icon: 'message', page: 'messages' } ];
            const navLinksHTML = navItems.map(item => `<a data-navigate="${item.page}" title="${item.name}" class="flex items-center px-4 py-2 mt-2 rounded-md cursor-pointer transition-colors duration-200 ${isSidebarCollapsed ? 'justify-center':''} ${currentPage === item.page ? 'bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-200' : 'text-gray-600 dark:text-gray-400 hover:bg-gray-200 dark:hover:bg-gray-700 hover:text-gray-700 dark:hover:text-gray-200'}">${ICONS[item.icon]} ${!isSidebarCollapsed ? `<span class="mx-4 font-medium">${item.name}</span>`:''}</a>`).join('');
            return `<div class="hidden md:flex flex-col px-4 py-8 bg-white border-r dark:bg-gray-900 dark:border-gray-700 transition-all duration-300 ${isSidebarCollapsed ? 'w-20' : 'w-64'}"> <div class="flex items-center justify-between"> ${!isSidebarCollapsed ? '<h2 class="text-3xl font-semibold text-gray-800 dark:text-white">Admin</h2>':''} <button data-action="toggle-sidebar" class="p-2 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-700">${isSidebarCollapsed ? ICONS.chevronRight : ICONS.chevronLeft}</button> </div> <div class="relative mt-6 ${isSidebarCollapsed ? 'hidden':'block'}"><span class="absolute inset-y-0 left-0 flex items-center pl-3">${ICONS.search}</span><input type="text" class="w-full py-2 pl-10 pr-4 text-gray-700 bg-white border rounded-md dark:bg-gray-800 dark:text-gray-300 dark:border-gray-600 focus:border-blue-400 dark:focus:border-blue-300 focus:ring-blue-300 focus:ring-opacity-40 focus:outline-none focus:ring" placeholder="Search"></div> <div class="flex flex-col justify-between flex-1 mt-6"><nav>${navLinksHTML}</nav><div class="flex flex-col items-center mt-6 -mx-2"> <button data-action="toggle-dark-mode" class="w-full flex items-center justify-center px-4 py-2 mb-2 text-gray-600 bg-gray-100 rounded-lg dark:bg-gray-800 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-700">${isDarkMode ? ICONS.sun : ICONS.moon} ${!isSidebarCollapsed ? `<span class="mx-2 font-medium">${isDarkMode ? 'Light':'Dark'}</span>`:''}</button> <a class="w-full flex items-center justify-center px-4 py-2 text-gray-600 bg-gray-100 rounded-lg dark:bg-gray-800 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-700" href="#">${ICONS.logout} ${!isSidebarCollapsed ? '<span class="mx-2 font-medium">Logout</span>':''}</a></div></div></div>`;
        };

        const renderHomePage = (projects) => {
            const stats = { total: projects.length, completed: projects.filter(p => p.overallStatus.label === 'Completed').length, inProgress: projects.filter(p => ['In Progress', 'At-Risk'].includes(p.overallStatus.label)).length, lagging: projects.filter(p => p.overallStatus.label === 'Lagging').length };
            const projectCards = projects.map(p => `<div data-navigate="${p.platform}" data-project-id="${p.id}" class="p-4 rounded-lg bg-gray-50 dark:bg-gray-700/50 cursor-pointer hover:shadow-lg transition-shadow"><div class="flex items-center justify-between"><div class="flex items-center gap-3"><div class="w-3 h-3 rounded-full ${p.platform === 'flame' ? 'bg-orange-500' : 'bg-blue-500'}"></div><p class="font-semibold text-gray-800 dark:text-gray-100">${p.name}</p></div>${renderStatusBadge(p.overallStatus)}</div><div class="mt-3">${renderProgressBar(p.overallProgress, p.overallStatus.color)}</div></div>`).join('');
            return `<div class="p-6 md:p-8 space-y-8"><h1 class="text-3xl font-bold text-gray-800 dark:text-white">Command Center</h1><div class="grid grid-cols-1 gap-8 md:grid-cols-2"><div data-navigate="flame" class="p-8 rounded-xl bg-gradient-to-br from-orange-400 to-red-500 text-white shadow-lg hover:shadow-2xl transform hover:-translate-y-1 transition-all duration-300 cursor-pointer"><h2 class="text-4xl font-bold">Flame</h2><p class="mt-2 text-lg opacity-80">Internal Creative Projects</p></div><div data-navigate="swayam" class="p-8 rounded-xl bg-gradient-to-br from-blue-400 to-indigo-500 text-white shadow-lg hover:shadow-2xl transform hover:-translate-y-1 transition-all duration-300 cursor-pointer"><h2 class="text-4xl font-bold">Swayam</h2><p class="mt-2 text-lg opacity-80">External Educational Courses</p></div></div><div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-md"><h3 class="text-xl font-semibold text-gray-800 dark:text-white mb-4">Dashboard Overview</h3><div class="flex flex-wrap items-center gap-4 mb-6 text-sm text-gray-600 dark:text-gray-300"><span>Total Projects: <span class="font-bold text-gray-900 dark:text-white">${stats.total}</span></span> <span class="text-green-600 dark:text-green-400">Completed: <span class="font-bold">${stats.completed}</span></span> <span class="text-blue-600 dark:text-blue-400">In Progress: <span class="font-bold">${stats.inProgress}</span></span> <span class="text-red-600 dark:text-red-400">Lagging: <span class="font-bold">${stats.lagging}</span></span></div><div class="space-y-4">${projectCards}</div></div></div>`;
        };

        const renderProjectDetailView = (project) => {
             if (project.name === 'New Untitled Project') {
                return `<div class="p-6 h-full flex flex-col items-center justify-center bg-gray-50 dark:bg-gray-800">
                    <div class="w-full max-w-md text-center">
                        <h2 class="text-2xl font-bold text-gray-800 dark:text-white mb-4">Set Up Your New Project</h2>
                        <p class="text-gray-600 dark:text-gray-300 mb-6">Start by giving your project a name.</p>
                        <form id="project-name-form" data-project-id="${project.id}" class="flex gap-2">
                            <input type="text" name="projectName" class="flex-grow w-full px-3 py-2 text-gray-700 bg-white border rounded-md dark:bg-gray-700 dark:text-gray-300 dark:border-gray-600 focus:border-blue-400 focus:outline-none focus:ring focus:ring-blue-300 focus:ring-opacity-40" placeholder="Enter project name..." autofocus>
                            <button type="submit" class="px-4 py-2 font-semibold text-white bg-blue-500 rounded-md hover:bg-blue-600">Save</button>
                        </form>
                    </div>
                </div>`;
            } else if (!project.projectManagerIds || project.projectManagerIds.length === 0) {
                const unassignedPMs = TEAM_MEMBERS.filter(m => m.role === 'Project Manager' && !project.projectManagerIds.includes(m.id));
                const pmOptions = unassignedPMs.map(pm => `<option value="${pm.id}">${pm.name}</option>`).join('');
                return `<div class="p-6 h-full bg-gray-50 dark:bg-gray-800">
                         <h2 class="text-3xl font-bold text-gray-800 dark:text-white">${project.name}</h2>
                         <p class="text-gray-500 dark:text-gray-400 mt-1">${project.scenario}</p>
                         <div class="mt-8 p-6 bg-white dark:bg-gray-700 rounded-lg shadow-md max-w-md mx-auto text-center">
                            <h3 class="text-xl font-semibold text-gray-800 dark:text-white">Assign Project Manager(s)</h3>
                            <p class="text-gray-600 dark:text-gray-300 mt-2 mb-4">Select managers to unlock project stages. You can add multiple.</p>
                            <select data-action="assign-pm" data-project-id="${project.id}" class="w-full p-2 border rounded-md dark:bg-gray-600 dark:border-gray-500 focus:ring-blue-500 focus:border-blue-500">
                                <option value="" selected disabled>Add a manager...</option>
                                ${pmOptions}
                            </select>
                         </div>
                    </div>`;
            }

            const projectManagers = TEAM_MEMBERS.filter(u => project.projectManagerIds.includes(u.id));
            const stagesHTML = project.stages.map(stage => {
                const isOpen = state.openSections[`${project.id}-${stage.id}`] !== false;
                
                const canAddTask = (platform) => platform === 'flame' || platform === 'swayam';

                let addTaskButtonHTML = '';
                if(canAddTask(project.platform)){
                    addTaskButtonHTML = `<button data-action="open-task-modal" data-project-id="${project.id}" data-stage-id="${stage.id}" class="p-1.5 text-gray-500 rounded-md hover:bg-gray-200 dark:hover:bg-gray-700">${ICONS.plus}</button>`;
                }

                const tasksHTML = stage.tasks.length > 0 ? stage.tasks.map(task => { 
                    const taskStatus = getTaskStatus(task); 
                    const colorClasses = { green: 'bg-green-500', yellow: 'bg-yellow-500', red: 'bg-red-500' };
                    const assignUserOptions = TEAM_MEMBERS.map(user => `<option value="${user.id}">${user.name}</option>`).join('');
                    return `<div class="p-3 bg-white dark:bg-gray-800 rounded-md">
                                <div class="flex items-center justify-between">
                                    <div class="flex items-center gap-3">
                                        <div class="w-2.5 h-2.5 rounded-full ${colorClasses[taskStatus.color]}"></div>
                                        <p class="text-gray-800 dark:text-gray-200">${task.name}</p>
                                    </div>
                                    <div class="flex items-center gap-4">
                                        <p class="text-sm text-gray-500 dark:text-gray-400">${new Date(task.startDate  + 'T00:00:00Z').toLocaleDateString()} - ${new Date(task.endDate + 'T00:00:00Z').toLocaleDateString()}</p>
                                        <button data-action="open-task-modal" data-project-id="${project.id}" data-stage-id="${stage.id}" data-task-id="${task.id}" class="p-1.5 text-gray-500 rounded-md hover:bg-gray-200 dark:hover:bg-gray-700">${ICONS.calendar}</button>
                                    </div>
                                </div>
                                <div class="flex items-center justify-between mt-2 pl-5">
                                     <div class="flex items-center -space-x-2">
                                        ${(task.assignedTeamMemberIds || []).map(id => renderAvatar(id, 'sm')).join('')}
                                        ${(!task.assignedTeamMemberIds || task.assignedTeamMemberIds.length === 0) ? '<div class="text-xs text-gray-400">Unassigned</div>' : ''}
                                     </div>
                                     <select data-action="assign-user-to-task" data-project-id="${project.id}" data-stage-id="${stage.id}" data-task-id="${task.id}" class="text-xs bg-gray-100 dark:bg-gray-700 border-gray-300 dark:border-gray-600 rounded-md focus:ring-blue-500 focus:border-blue-500">
                                        <option value="" selected disabled>Assign...</option>
                                        ${assignUserOptions}
                                     </select>
                                </div>
                            </div>`; 
                }).join('') : '<p class="text-sm text-gray-500 dark:text-gray-400 text-center py-2">No tasks in this stage yet.</p>';
                
                const assignOptions = TEAM_MEMBERS.map(user => `<option value="${user.id}">${user.name}</option>`).join('');
                
                return `<div class="bg-gray-50 dark:bg-gray-900/50 rounded-lg border border-gray-200 dark:border-gray-700"><div data-action="toggle-section" data-section-id="${project.id}-${stage.id}" class="p-4 flex justify-between items-center cursor-pointer"><div><h4 class="font-semibold text-lg text-gray-800 dark:text-gray-100">${stage.name}</h4><div class="mt-2">${renderProgressBar(stage.progress, stage.status.color)}</div></div><div class="flex items-center gap-4">${renderStatusBadge(stage.status)}<div class="transform transition-transform ${isOpen ? 'rotate-180':''}">${ICONS.chevronDown}</div></div></div> ${isOpen ? `<div class="p-4 border-t border-gray-200 dark:border-gray-700"><div class="flex justify-between items-center mb-3"><h5 class="font-semibold text-gray-700 dark:text-gray-300">Tasks</h5>${addTaskButtonHTML}</div><div class="space-y-3">${tasksHTML}</div><h5 class="font-semibold text-gray-700 dark:text-gray-300 mt-6 mb-3">Assigned Stage Personnel</h5><div class="flex items-center justify-between p-3 bg-white dark:bg-gray-800 rounded-md"><div class="flex items-center -space-x-2">${stage.assignedTeamMemberIds.map(id => renderAvatar(id)).join('')} ${stage.assignedTeamMemberIds.length === 0 ? '<p class="text-sm text-gray-500 ml-2">No one assigned</p>':''}</div><select data-action="assign-user" data-project-id="${project.id}" data-stage-id="${stage.id}" class="text-sm bg-gray-100 dark:bg-gray-700 border-gray-300 dark:border-gray-600 rounded-md focus:ring-blue-500 focus:border-blue-500"><option value="" selected disabled>Assign user...</option>${assignOptions}</select></div></div>` : ''}</div>`;
            }).join('');
            const updatesHTML = project.updates.sort((a,b) => new Date(b.timestamp) - new Date(a.timestamp)).map(update => { const author = TEAM_MEMBERS.find(u => u.id === update.authorId); const urgencyClasses = { green: 'border-green-500', yellow: 'border-yellow-500', red: 'border-red-500' }; return `<div class="p-4 bg-white dark:bg-gray-800 rounded-md border-l-4 ${urgencyClasses[update.urgency]}"><div class="flex items-center gap-3">${renderAvatar(author.id)}<div><p class="font-semibold text-gray-800 dark:text-gray-100">${author.name}</p><p class="text-xs text-gray-500 dark:text-gray-400">${new Date(update.timestamp).toLocaleString()}</p></div></div><p class="mt-3 text-gray-600 dark:text-gray-300">${update.message}</p></div>`; }).join('');
            return `<div class="p-6 h-full overflow-y-auto"><div class="flex justify-between items-start"><div><h2 class="text-3xl font-bold text-gray-800 dark:text-white">${project.name}</h2><p class="text-gray-500 dark:text-gray-400 mt-1">${project.scenario}</p><div class="flex items-center gap-4 mt-3">${projectManagers.map(pm => `<div class="flex items-center gap-2"> ${renderAvatar(pm.id)} <div> <p class="font-semibold text-gray-700 dark:text-gray-200">${pm.name}</p> <p class="text-xs text-gray-500 dark:text-gray-400">Project Manager</p> </div> </div>`).join('')}</div></div><div class="flex items-center gap-4">${renderStatusBadge(project.overallStatus)}<button data-action="delete-project" data-project-id="${project.id}" class="p-2 text-gray-500 rounded-full hover:bg-red-100 hover:text-red-600 dark:hover:bg-red-900/50 dark:hover:text-red-400 transition">${ICONS.trash}</button></div></div><div class="mt-6"><h3 class="text-sm font-semibold text-gray-600 dark:text-gray-300 mb-2">Overall Project Progress</h3>${renderProgressBar(project.overallProgress, project.overallStatus.color)}</div><div class="mt-8 space-y-4">${stagesHTML}</div><div class="mt-8 pb-8"><h3 class="text-xl font-semibold text-gray-800 dark:text-white mb-4">Updates & Notes</h3><form id="update-form" data-project-id="${project.id}" class="p-4 bg-gray-50 dark:bg-gray-900/50 rounded-lg"><textarea name="message" class="w-full p-2 border rounded-md bg-white dark:bg-gray-800 border-gray-300 dark:border-gray-600 focus:ring-blue-500 focus:border-blue-500" rows="3" placeholder="Post a new update..."></textarea><div class="flex justify-between items-center mt-3"><div class="flex items-center gap-2" id="urgency-buttons"><button type="button" data-urgency="green" class="px-3 py-1 text-sm rounded-md transition bg-green-500 text-white">On Track</button><button type-button" data-urgency="yellow" class="px-3 py-1 text-sm rounded-md transition bg-gray-200 dark:bg-gray-600 text-gray-700 dark:text-gray-300 hover:bg-gray-300 dark:hover:bg-gray-500">Caution</button><button type="button" data-urgency="red" class="px-3 py-1 text-sm rounded-md transition bg-gray-200 dark:bg-gray-600 text-gray-700 dark:text-gray-300 hover:bg-gray-300 dark:hover:bg-gray-500">Urgent</button></div><button type="submit" class="px-4 py-2 bg-blue-500 text-white rounded-md hover:bg-blue-600 font-semibold">Post</button></div></form><div class="mt-6 space-y-4">${updatesHTML}</div></div></div>`;
        };
        
        const renderPlatformWorkspace = (platform, projects) => {
            const platformProjects = projects.filter(p => p.platform === platform);
            const selectedId = state.selectedProjectIdByPlatform[platform];
            if (state.pendingProjectId && platformProjects.some(p => p.id === state.pendingProjectId)) {
                state.selectedProjectIdByPlatform[platform] = state.pendingProjectId;
                state.pendingProjectId = null;
            } else if (!selectedId || !platformProjects.some(p=>p.id === selectedId)) {
                state.selectedProjectIdByPlatform[platform] = platformProjects.length > 0 ? platformProjects[0].id : null;
            }
            const selectedProject = platformProjects.find(p => p.id === state.selectedProjectIdByPlatform[platform]);
            const colors = { flame: { text: 'text-orange-500', bg: 'bg-orange-500/10' }, swayam: { text: 'text-blue-500', bg: 'bg-blue-500/10' } };
            const listHTML = platformProjects.map(p => `<div data-action="select-project" data-project-id="${p.id}" class="p-4 border-b dark:border-gray-700 cursor-pointer transition-colors ${state.selectedProjectIdByPlatform[platform] === p.id ? colors[platform].bg : 'hover:bg-gray-100 dark:hover:bg-gray-800/50'}"><div class="flex justify-between items-center"><p class="font-semibold text-gray-800 dark:text-gray-100">${p.name}</p>${renderStatusBadge(p.overallStatus)}</div><div class="mt-2">${renderProgressBar(p.overallProgress, p.overallStatus.color)}</div></div>`).join('');
            return `<div class="flex h-full"><div class="w-full md:w-1/3 border-r dark:border-gray-700 flex flex-col h-full"><div class="p-4 border-b dark:border-gray-700 flex justify-between items-center"><h2 class="text-2xl font-bold capitalize ${colors[platform].text}">${platform} Projects</h2><button data-action="add-project" data-platform="${platform}" class="flex items-center gap-2 px-3 py-1.5 text-sm font-semibold text-white bg-blue-500 rounded-md hover:bg-blue-600 transition">${ICONS.plus}<span>Add Project</span></button></div><div class="flex-grow overflow-y-auto">${listHTML}</div></div><div class="hidden md:block md:w-2/3 bg-white dark:bg-gray-800">${selectedProject ? renderProjectDetailView(selectedProject) : `<div class="h-full flex items-center justify-center"><p class="text-gray-500 dark:text-gray-400 text-lg">Select or add a project</p></div>`}</div></div>`;
        };

        const renderUsersPage = (projects, selectedUserId = TEAM_MEMBERS[0].id) => {
            const selectedUser = TEAM_MEMBERS.find(u => u.id === selectedUserId);
            const userProjects = projects.filter(p => p.stages.some(s => s.assignedTeamMemberIds.includes(selectedUserId) || s.tasks.some(t => t.assignedTeamMemberIds.includes(selectedUserId))));
            const userListHTML = TEAM_MEMBERS.map(user => `<div data-action="select-user" data-user-id="${user.id}" class="flex items-center gap-4 p-4 border-b dark:border-gray-700 cursor-pointer transition-colors ${selectedUserId === user.id ? 'bg-gray-100 dark:bg-gray-800' : 'hover:bg-gray-50 dark:hover:bg-gray-800/50'}">${renderAvatar(user.id)}<div><p class="font-semibold text-gray-800 dark:text-gray-100">${user.name}</p><p class="text-sm text-gray-500 dark:text-gray-400">${user.role}</p></div></div>`).join('');
            const projectListHTML = userProjects.length > 0 ? userProjects.map(p => `<div data-navigate="${p.platform}" data-project-id="${p.id}" class="p-4 rounded-lg bg-gray-50 dark:bg-gray-700/50 cursor-pointer hover:shadow-lg transition-shadow"><div class="flex items-center justify-between"><div class="flex items-center gap-3"><div class="w-3 h-3 rounded-full ${p.platform === 'flame' ? 'bg-orange-500' : 'bg-blue-500'}"></div><p class="font-semibold text-gray-800 dark:text-gray-100">${p.name}</p></div>${renderStatusBadge(p.overallStatus)}</div><div class="mt-3">${renderProgressBar(p.overallProgress, p.overallStatus.color)}</div></div>`).join('') : '<p class="text-gray-500 dark:text-gray-400">No projects assigned to this user.</p>';
            return `<div class="flex h-full"><div class="w-full md:w-1/3 border-r dark:border-gray-700 flex flex-col h-full"><div class="p-4 border-b dark:border-gray-700"><h2 class="text-2xl font-bold text-gray-800 dark:text-white">Team Members</h2></div><div class="flex-grow overflow-y-auto">${userListHTML}</div></div><div class="hidden md:block md:w-2/3 bg-white dark:bg-gray-800 p-6 overflow-y-auto">${selectedUser ? `<div><div class="flex items-center gap-4">${renderAvatar(selectedUser.id, 'lg')}<div><h3 class="text-2xl font-bold text-gray-800 dark:text-white">${selectedUser.name}</h3><p class="text-gray-500 dark:text-gray-400">${selectedUser.role}</p></div></div><div class="mt-8"><h4 class="text-xl font-semibold text-gray-800 dark:text-white mb-4">Assigned Projects (${userProjects.length})</h4><div class="space-y-4">${projectListHTML}</div></div></div>` : ''}</div></div>`;
        };

        const renderPlaceholderPage = (title, message) => `<div class="p-6 md:p-8"><h1 class="text-3xl font-bold text-gray-800 dark:text-white">${title}</h1><div class="mt-8 bg-white dark:bg-gray-800 p-6 rounded-xl shadow-md"><p class="text-gray-600 dark:text-gray-300">${message}</p></div></div>`;
        
        const renderConfirmationModal = () => {
            const { title, message } = state.confirmationModal;
            return `<div id="confirmation-modal" class="fixed inset-0 bg-black/60 z-50 flex items-center justify-center p-4 modal-enter-active"><div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl p-6 w-full max-w-md"><h3 class="text-lg font-bold text-gray-900 dark:text-white">${title}</h3><p class="mt-2 text-sm text-gray-600 dark:text-gray-300">${message}</p><div class="mt-6 flex justify-end gap-3"><button data-action="modal-close" class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-100 rounded-md hover:bg-gray-200 dark:bg-gray-700 dark:text-gray-200 dark:hover:bg-gray-600">Cancel</button><button id="modal-confirm-btn" class="px-4 py-2 text-sm font-medium text-white bg-red-600 rounded-md hover:bg-red-700">Confirm</button></div></div></div>`;
        };

        const renderTaskModal = () => {
            const { mode, task = {} } = state.taskModal;
            const title = mode === 'add' ? 'Add New Task' : `Edit Task`;
            const taskName = task.name || '';
            const startDate = task.startDate || '';
            const endDate = task.endDate || '';

            const renderCalendar = (viewDate, selectedStart, selectedEnd) => {
                const year = viewDate.getFullYear(), month = viewDate.getMonth();
                const firstDay = new Date(year, month, 1).getDay();
                const daysInMonth = new Date(year, month + 1, 0).getDate();
                let daysHTML = '';
                for (let i = 0; i < firstDay; i++) daysHTML += `<div class="w-10 h-10"></div>`;
                for (let day = 1; day <= daysInMonth; day++) {
                    const d = new Date(Date.UTC(year, month, day));
                    let bg = 'hover:bg-blue-100 dark:hover:bg-blue-800/50';
                    if (selectedStart && selectedEnd && d >= selectedStart && d <= selectedEnd) {
                        bg = 'bg-blue-500 text-white rounded-md';
                    } else if (selectedStart && !selectedEnd && d.getTime() === selectedStart.getTime()) {
                        bg = 'bg-blue-500 text-white rounded-full';
                    }
                    daysHTML += `<div data-day="${day}" class="w-10 h-10 flex items-center justify-center cursor-pointer rounded-full transition-colors ${bg}">${day}</div>`;
                }
                return daysHTML;
            };

            const initialViewDate = new Date(startDate ? startDate + 'T00:00:00Z' : Date.now());

            return `<div id="task-modal" class="fixed inset-0 bg-black/60 z-50 flex items-center justify-center p-4 modal-enter-active" data-action="modal-close">
                <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl p-6 w-full max-w-md" onclick="event.stopPropagation()">
                    <h3 class="text-lg font-bold text-gray-900 dark:text-white">${title}</h3>
                    <form id="task-form" class="mt-4 space-y-4">
                        <div>
                            <label for="taskName" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Task Name</label>
                            <input type="text" id="taskName" name="taskName" value="${taskName}" required class="mt-1 block w-full px-3 py-2 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                        </div>
                         <div>
                            <p class="block text-sm font-medium text-gray-700 dark:text-gray-300">Date Range</p>
                            <div class="flex items-center gap-2 mt-1">
                                <input type="text" id="startDate" name="startDate" value="${startDate}" readonly class="w-1/2 text-center p-2 bg-gray-100 dark:bg-gray-700 rounded-md border border-gray-300 dark:border-gray-600" placeholder="Start Date">
                                <span>-</span>
                                <input type="text" id="endDate" name="endDate" value="${endDate}" readonly class="w-1/2 text-center p-2 bg-gray-100 dark:bg-gray-700 rounded-md border border-gray-300 dark:border-gray-600" placeholder="End Date">
                            </div>
                        </div>
                        <div id="calendar-container">
                            <div class="flex items-center justify-between mb-2">
                                <button type="button" data-action="prev-month" class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700">${ICONS.chevronLeft}</button>
                                <span id="calendar-month-year" class="font-semibold text-gray-800 dark:text-gray-200">${initialViewDate.toLocaleString('default', { month: 'long', year: 'numeric', timeZone: 'UTC' })}</span>
                                <button type="button" data-action="next-month" class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700">${ICONS.chevronRight}</button>
                            </div>
                            <div class="grid grid-cols-7 gap-2 text-center text-sm text-gray-500 dark:text-gray-400 mb-2">${['S','M','T','W','T','F','S'].map(d => `<div>${d}</div>`).join('')}</div>
                            <div id="calendar-grid" class="grid grid-cols-7 gap-2 text-center">${renderCalendar(initialViewDate, startDate ? new Date(startDate+'T00:00:00Z') : null, endDate ? new Date(endDate+'T00:00:00Z'): null)}</div>
                        </div>
                        <div class="mt-6 flex justify-end gap-3">
                            <button type="button" data-action="modal-close" class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-100 rounded-md hover:bg-gray-200 dark:bg-gray-700 dark:text-gray-200 dark:hover:bg-gray-600">Cancel</button>
                            <button type="submit" class="px-4 py-2 text-sm font-medium text-white bg-blue-600 rounded-md hover:bg-blue-700 disabled:opacity-50" disabled>Save</button>
                        </div>
                    </form>
                </div>
            </div>`;
        };
        
        // --- MAIN APP RENDER ---
        const renderApp = () => {
            const projectsWithHealth = calculateAllProjectsHealth(state.projects);
            const appRoot = document.getElementById('app-root');
            const modalContainer = document.getElementById('modal-container');
            
            let pageHTML;
            switch (state.currentPage) {
                case 'home': pageHTML = renderHomePage(projectsWithHealth); break;
                case 'flame': case 'swayam': pageHTML = renderPlatformWorkspace(state.currentPage, projectsWithHealth); break;
                case 'users': pageHTML = renderUsersPage(projectsWithHealth, state.selectedUserId); break;
                case 'profile': pageHTML = renderPlaceholderPage("Profile", "User profile, settings, and activity logs."); break;
                case 'settings': pageHTML = renderPlaceholderPage("Settings", "Application-wide settings and preferences."); break;
                case 'notifications': pageHTML = renderPlaceholderPage("Notifications", "All project updates and alerts."); break;
                case 'messages': pageHTML = renderPlaceholderPage("Messages", "Direct messaging for team collaboration."); break;
                default: pageHTML = renderHomePage(projectsWithHealth);
            }
            appRoot.innerHTML = `${renderSidebar()}<main class="flex-1 flex flex-col overflow-hidden"><div class="flex-1 overflow-x-hidden overflow-y-auto bg-gray-100 dark:bg-gray-950">${pageHTML}</div></main>`;
            
            modalContainer.innerHTML = '';
            if (state.confirmationModal.isOpen) {
                modalContainer.innerHTML = renderConfirmationModal();
                document.getElementById('modal-confirm-btn').onclick = state.confirmationModal.onConfirm;
            }
            if (state.taskModal.isOpen) {
                modalContainer.innerHTML = renderTaskModal();
                attachCalendarLogic();
            }
        };

        // --- STATE MUTATION & EVENT HANDLERS ---
        const navigate = (page, projectId = null) => { state.currentPage = page; state.pendingProjectId = projectId; renderApp(); };
        const toggleDarkMode = () => { state.isDarkMode = !state.isDarkMode; document.documentElement.classList.toggle('dark', state.isDarkMode); renderApp(); };
        const toggleSidebar = () => { state.isSidebarCollapsed = !state.isSidebarCollapsed; renderApp(); };
        const selectProject = (projectId) => { state.selectedProjectIdByPlatform[state.currentPage] = projectId; renderApp(); };
        const selectUser = (userId) => { state.selectedUserId = userId; renderApp(); };
        
        const assignUser = (projectId, stageId, userId) => {
            const project = state.projects.find(p => p.id === projectId);
            const targetStage = project?.stages.find(s => s.id === stageId);
            if (targetStage && !targetStage.assignedTeamMemberIds.includes(userId)) {
                 targetStage.assignedTeamMemberIds.push(userId);
            }
            renderApp();
        };

        const assignUserToTask = (projectId, stageId, taskId, userId) => {
            const project = state.projects.find(p => p.id === projectId);
            const stage = project?.stages.find(s => s.id === stageId);
            const task = stage?.tasks.find(t => t.id === taskId);
            if (task) {
                if (!task.assignedTeamMemberIds) task.assignedTeamMemberIds = [];
                if (!task.assignedTeamMemberIds.includes(userId)) {
                    task.assignedTeamMemberIds.push(userId);
                }
            }
            renderApp();
        };

        const toggleSection = (sectionId) => { state.openSections[sectionId] = state.openSections[sectionId] === false; renderApp(); };
        const postUpdate = (projectId, formData) => {
            const project = state.projects.find(p => p.id === projectId);
            if(project && formData.get('message').trim()){
                const newUpdate = { id: `up${Date.now()}`, authorId: 'u2', timestamp: new Date().toISOString(), message: formData.get('message'), urgency: state.currentUrgency || 'green' };
                project.updates.push(newUpdate);
                state.currentUrgency = 'green';
                renderApp();
            }
        };
        const addProject = (platform) => {
            const newProject = { id: `p${Date.now()}`, name: 'New Untitled Project', platform: platform, scenario: 'Awaiting Setup', projectManagerIds: [], updates: [], stages: [] };
            state.projects.unshift(newProject);
            state.selectedProjectIdByPlatform[platform] = newProject.id;
            renderApp();
        };
        const saveProjectName = (projectId, newName) => {
            const project = state.projects.find(p => p.id === projectId);
            if(project && newName.trim()){
                project.name = newName.trim();
                renderApp();
            }
        };
        const addProjectManager = (projectId, pmId) => {
            const project = state.projects.find(p => p.id === projectId);
            if (project && !project.projectManagerIds.includes(pmId)) {
                project.projectManagerIds.push(pmId);

                // Add stages only when the first manager is assigned
                if (project.stages.length === 0) {
                     project.scenario = 'Newly Assigned';
                     project.stages = [
                        { id: `s${Date.now()}-1`, name: 'Pre-Production', assignedTeamMemberIds: [], tasks: [] },
                        { id: `s${Date.now()}-2`, name: 'Production', assignedTeamMemberIds: [], tasks: [] },
                        { id: `s${Date.now()}-3`, name: 'Post-Production', assignedTeamMemberIds: [], tasks: [] }
                    ];
                }
            }
            renderApp();
        };
        const deleteProject = (projectId) => {
            state.confirmationModal = { isOpen: true, title: 'Delete Project', message: 'Are you sure you want to permanently delete this project?', onConfirm: () => { state.projects = state.projects.filter(p => p.id !== projectId); state.confirmationModal = { isOpen: false }; renderApp(); } };
            renderApp();
        };
        
        const openTaskModal = (projectId, stageId, taskId = null) => {
            if (taskId) {
                const project = state.projects.find(p => p.id === projectId);
                const stage = project.stages.find(s => s.id === stageId);
                const task = stage.tasks.find(t => t.id === taskId);
                state.taskModal = { isOpen: true, mode: 'edit', task, projectId, stageId };
            } else {
                state.taskModal = { isOpen: true, mode: 'add', task: {}, projectId, stageId };
            }
            renderApp();
        };

        const saveTask = (formData) => {
            const { mode, projectId, stageId, task } = state.taskModal;
            const project = state.projects.find(p => p.id === projectId);
            const stage = project?.stages.find(s => s.id === stageId);
            if (!stage) return;

            const updatedTaskData = {
                name: formData.get('taskName'),
                startDate: formData.get('startDate'),
                endDate: formData.get('endDate'),
            };

            if(mode === 'add') {
                stage.tasks.push({ id: `t${Date.now()}`, assignedTeamMemberIds: [], ...updatedTaskData });
            } else {
                const taskIndex = stage.tasks.findIndex(t => t.id === task.id);
                if(taskIndex > -1) {
                    stage.tasks[taskIndex] = { ...stage.tasks[taskIndex], ...updatedTaskData };
                }
            }
            closeModal();
        };
        
        const closeModal = () => { state.confirmationModal = { isOpen: false }; state.taskModal = { isOpen: false }; renderApp(); };

        // --- CALENDAR LOGIC (for Task Modal) ---
        const attachCalendarLogic = () => {
            const modal = document.getElementById('task-modal');
            if (!modal) return;

            let viewDate = new Date(state.taskModal.task.startDate ? state.taskModal.task.startDate + 'T00:00:00Z' : Date.now());
            let startDate = state.taskModal.task.startDate ? new Date(state.taskModal.task.startDate+'T00:00:00Z') : null;
            let endDate = state.taskModal.task.endDate ? new Date(state.taskModal.task.endDate+'T00:00:00Z') : null;
            
            const startDateInput = modal.querySelector('#startDate');
            const endDateInput = modal.querySelector('#endDate');
            const saveButton = modal.querySelector('button[type="submit"]');

            const updateCalendar = () => {
                modal.querySelector('#calendar-month-year').textContent = viewDate.toLocaleString('default', { month: 'long', year: 'numeric', timeZone: 'UTC' });
                let daysHTML = '';
                const year = viewDate.getUTCFullYear(), month = viewDate.getUTCMonth();
                const firstDay = new Date(Date.UTC(year, month, 1)).getUTCDay();
                const daysInMonth = new Date(Date.UTC(year, month + 1, 0)).getUTCDate();
                for (let i = 0; i < firstDay; i++) daysHTML += `<div class="w-10 h-10"></div>`;
                for (let day = 1; day <= daysInMonth; day++) {
                    const d = new Date(Date.UTC(year, month, day));
                    let bg = 'hover:bg-blue-100 dark:hover:bg-blue-800/50';
                    if (startDate && endDate && d >= startDate && d <= endDate) bg = 'bg-blue-500 text-white rounded-md';
                    else if (startDate && !endDate && d.getTime() === startDate.getTime()) bg = 'bg-blue-500 text-white rounded-full';
                    daysHTML += `<div data-day="${day}" class="w-10 h-10 flex items-center justify-center cursor-pointer rounded-full transition-colors ${bg}">${day}</div>`;
                }
                modal.querySelector('#calendar-grid').innerHTML = daysHTML;
                saveButton.disabled = !(startDate && endDate && modal.querySelector('#taskName').value.trim());
            };

            modal.addEventListener('click', e => {
                const target = e.target.closest('[data-action], [data-day]');
                if(!target) return;

                let needsUpdate = false;
                if(target.dataset.action === 'prev-month') {
                    viewDate.setUTCMonth(viewDate.getUTCMonth() - 1);
                    needsUpdate = true;
                }
                if(target.dataset.action === 'next-month') {
                    viewDate.setUTCMonth(viewDate.getUTCMonth() + 1);
                    needsUpdate = true;
                }
                
                if(target.dataset.day) {
                    const day = parseInt(target.dataset.day, 10);
                    const newDate = new Date(Date.UTC(viewDate.getUTCFullYear(), viewDate.getUTCMonth(), day));
                    if (!startDate || (startDate && endDate)) { startDate = newDate; endDate = null; } 
                    else if (newDate < startDate) { startDate = newDate; }
                    else { endDate = newDate; }

                    startDateInput.value = startDate ? startDate.toISOString().split('T')[0] : '';
                    endDateInput.value = endDate ? endDate.toISOString().split('T')[0] : '';
                    needsUpdate = true;
                }
                if (needsUpdate) updateCalendar();
            });
            modal.querySelector('#taskName').addEventListener('input', () => {
                saveButton.disabled = !(startDate && endDate && modal.querySelector('#taskName').value.trim());
            });
        };

        // --- GLOBAL EVENT LISTENERS ---
        document.addEventListener('click', (e) => {
            const nav = e.target.closest('[data-navigate]');
            if (nav) return navigate(nav.dataset.navigate, nav.dataset.projectId || null);
            const action = e.target.closest('[data-action]');
            if (action) {
                 if (action.id === 'task-modal' && action.dataset.action === 'modal-close') {
                     closeModal();
                     return;
                 }
                e.preventDefault();
                const { dataset } = action;
                switch(dataset.action) {
                    case 'toggle-dark-mode': toggleDarkMode(); break;
                    case 'toggle-sidebar': toggleSidebar(); break;
                    case 'select-project': selectProject(dataset.projectId); break;
                    case 'select-user': selectUser(dataset.userId); break;
                    case 'delete-project': deleteProject(dataset.projectId); break;
                    case 'add-project': addProject(dataset.platform); break;
                    case 'toggle-section': toggleSection(dataset.sectionId); break;
                    case 'open-task-modal': openTaskModal(dataset.projectId, dataset.stageId, dataset.taskId); break;
                    case 'modal-close': closeModal(); break;
                }
            }
        });

        document.addEventListener('change', (e) => {
            const assignToStage = e.target.closest('[data-action="assign-user"]');
            if (assignToStage) {
                assignUser(assignToStage.dataset.projectId, assignToStage.dataset.stageId, e.target.value);
                e.target.value = "";
                return;
            }
            const assignToTask = e.target.closest('[data-action="assign-user-to-task"]');
            if (assignToTask) {
                assignUserToTask(assignToTask.dataset.projectId, assignToTask.dataset.stageId, assignToTask.dataset.taskId, e.target.value);
                e.target.value = "";
                return;
            }
             const assignPM = e.target.closest('[data-action="assign-pm"]');
            if (assignPM) {
                if(e.target.value) {
                    addProjectManager(assignPM.dataset.projectId, e.target.value);
                }
            }
        });

        document.addEventListener('submit', (e) => {
             e.preventDefault();
            if(e.target.id === 'update-form') {
                postUpdate(e.target.dataset.projectId, new FormData(e.target));
            }
            if(e.target.id === 'task-form') {
                saveTask(new FormData(e.target));
            }
            if(e.target.id === 'project-name-form'){
                const formData = new FormData(e.target);
                saveProjectName(e.target.dataset.projectId, formData.get('projectName'));
            }
        });
        
        document.addEventListener('click', (e) => {
             const urgencyButton = e.target.closest('#urgency-buttons button');
             if(urgencyButton) {
                 state.currentUrgency = urgencyButton.dataset.urgency;
                 document.querySelectorAll('#urgency-buttons button').forEach(btn => {
                     const isSelected = btn === urgencyButton;
                     const level = btn.dataset.urgency;
                     btn.className = `px-3 py-1 text-sm rounded-md transition ${isSelected ? (level==='green' ? 'bg-green-500 text-white':level==='yellow' ? 'bg-yellow-500 text-white':'bg-red-500 text-white') : 'bg-gray-200 dark:bg-gray-600 text-gray-700 dark:text-gray-300 hover:bg-gray-300 dark:hover:bg-gray-500'}`;
                 });
             }
        });

        // --- INITIAL RENDER ---
        document.addEventListener('DOMContentLoaded', renderApp);
    </script>
</body>
</html>

